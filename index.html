<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Run a Thousand - Progress Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #visualization {
      width: 100%;
      max-width: 1400px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    #error {
      text-align: center;
      padding: 40px;
      color: #c00;
    }
  </style>
</head>
<body>
  <div id="visualization">
    <div id="loading">Loading progress data...</div>
  </div>

  <script>
    // Google Sheet CSV URL (published sheet)
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSCUqjKPxn_zHvJKO5IOmO0pyfs6m9CqqkHRWu3jIFoXZEjo53-ukOVC41kr0Ye0sgsRKdbtHdrgRvo/pub?gid=1081820459&single=true&output=csv';
    
    // Runner colors (matching original SVG)
    const RUNNER_COLORS = {
      'Blair': '#FF6B6B',
      'Clark': '#9D84B7',
      'Dave': '#4ECDC4',
      'Jacob': '#E63946',
      'John': '#8B4513',
      'Karla': '#5B9AA0',
      'Keri': '#FF6B35',
      'Kristy': '#FFB6C1',
      'Kristyn': '#F4A261',
      'Matthew': '#6A4C93',
      'Tyler': '#2A9D8F',
      'Will': '#FFD93D'
    };

    // Fetch and parse CSV data
    async function fetchSheetData() {
      try {
        const response = await fetch(SHEET_CSV_URL);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const csvText = await response.text();
        const rows = csvText.split('\n').map(row => {
          // Handle CSV parsing (simple version - assumes no commas in values)
          return row.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
        });
        
        // Find header row to get column indices
        let nameCol = -1;
        let milesCol = -1;
        let headerRowIndex = -1;
        
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          for (let j = 0; j < row.length; j++) {
            const cell = row[j].toLowerCase();
            if (cell === 'name') nameCol = j;
            if (cell === 'current total' || cell === 'miles') milesCol = j;
          }
          if (nameCol >= 0 && milesCol >= 0) {
            headerRowIndex = i;
            break;
          }
        }
        
        if (nameCol < 0 || milesCol < 0) {
          throw new Error('Could not find "Name" and "Current Total" columns');
        }
        
        // Parse data rows
        const data = [];
        for (let i = headerRowIndex + 1; i < rows.length; i++) {
          const row = rows[i];
          if (row.length > Math.max(nameCol, milesCol)) {
            const name = row[nameCol].trim();
            const miles = parseFloat(row[milesCol]);
            
            // Only include known runners with valid miles
            if (name && !isNaN(miles) && RUNNER_COLORS[name]) {
              data.push({ name, miles, color: RUNNER_COLORS[name] });
            }
          }
        }
        
        // Sort alphabetically by name
        data.sort((a, b) => a.name.localeCompare(b.name));
        
        return data;
      } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
      }
    }

    // Calculate pace line position (miles needed to be on track)
    function calculatePaceMiles() {
      const now = new Date();
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000)) + 1;
      return Math.round((dayOfYear / 365) * 1000);
    }

    // Generate SVG
    function generateSVG(runners) {
      const paceMiles = calculatePaceMiles();
      const totalMiles = runners.reduce((sum, r) => sum + r.miles, 0);
      
      // SVG dimensions and layout
      const width = 1400;
      const height = 800;
      const leftMargin = 150;
      const rightMargin = 50;
      const trackStart = 150;
      const trackEnd = 1350;
      const trackWidth = trackEnd - trackStart;
      
      // Calculate Y positions for runners
      const titleHeight = 70;
      const bottomPadding = 80;
      const availableHeight = height - titleHeight - bottomPadding;
      const rowHeight = availableHeight / runners.length;
      const startY = titleHeight + 50;
      
      // Helper function to convert miles to X position
      const milesToX = (miles) => trackStart + (miles / 1000) * trackWidth;
      
      // Build SVG string
      let svg = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: 100vh; display: block;">
  <defs>
    <filter id="shadow">
      <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
      <feOffset dx="1" dy="2"/>
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.4"/>
      </feComponentTransfer>
      <feMerge>
        <feMergeNode/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    
    <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" />
      <stop offset="50%" style="stop-color:#F8F8F8;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#F0F0F0;stop-opacity:1" />
    </linearGradient>
    
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(0,0,0,0.03)" stroke-width="1"/>
    </pattern>
  </defs>
  
  <!-- Background -->
  <rect width="${width}" height="${height}" fill="url(#bgGradient)"/>
  <rect width="${width}" height="${height}" fill="url(#grid)"/>
  
  <!-- Corner flourishes -->
  <path d="M 0 0 L 80 0 L 80 3 L 3 3 L 3 80 L 0 80 Z" fill="rgba(0,0,0,0.08)"/>
  <path d="M ${width} 0 L ${width-80} 0 L ${width-80} 3 L ${width-3} 3 L ${width-3} 80 L ${width} 80 Z" fill="rgba(0,0,0,0.08)"/>
  <path d="M 0 ${height} L 80 ${height} L 80 ${height-3} L 3 ${height-3} L 3 ${height-80} L 0 ${height-80} Z" fill="rgba(0,0,0,0.08)"/>
  <path d="M ${width} ${height} L ${width-80} ${height} L ${width-80} ${height-3} L ${width-3} ${height-3} L ${width-3} ${height-80} L ${width} ${height-80} Z" fill="rgba(0,0,0,0.08)"/>
  
  <!-- Title -->
  <text x="${width/2}" y="50" font-family="system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif" font-size="42" font-weight="400" fill="#1A1A1A" text-anchor="middle" letter-spacing="3">Progress and Milestones</text>
  
  <!-- Scale markers -->
  <text x="${trackStart}" y="90" font-family="system-ui" font-size="16" font-weight="600" fill="#1A1A1A" text-anchor="middle">0</text>
  <text x="${trackEnd}" y="90" font-family="system-ui" font-size="16" font-weight="600" fill="#1A1A1A" text-anchor="middle">1000</text>`;

      // Add runner tracks
      runners.forEach((runner, index) => {
        const y = startY + (index * rowHeight);
        const progressX = milesToX(runner.miles);
        
        svg += `
  
  <!-- ${runner.name} (${runner.miles}) -->
  <line x1="${trackStart}" y1="${y}" x2="${trackEnd}" y2="${y}" stroke="#DDD" stroke-width="8" stroke-linecap="round"/>
  ${runner.miles > 0 ? `<line x1="${trackStart}" y1="${y}" x2="${progressX}" y2="${y}" stroke="${runner.color}" stroke-width="8" stroke-linecap="round"/>` : ''}
  <text x="50" y="${y + 5}" font-family="system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif" font-size="18" font-weight="500" fill="#1A1A1A" text-anchor="start">${runner.name}</text>`;
      });

      // Milestone lines
      const milestoneY1 = startY - 20;
      const milestoneY2 = startY + ((runners.length - 1) * rowHeight) + 25;
      const labelY = milestoneY2 + 30;
      
      // Pace line
      const paceX = milesToX(paceMiles);
      svg += `
  
  <!-- Pace line (${paceMiles} miles) -->
  <line x1="${paceX}" y1="${milestoneY1}" x2="${paceX}" y2="${milestoneY2}" stroke="#00AA00" stroke-width="3" stroke-dasharray="8,8"/>
  <text x="${paceX}" y="${milestoneY1 - 10}" font-family="system-ui" font-size="16" font-weight="600" fill="#00AA00" text-anchor="middle">Pace</text>
  <text x="${paceX}" y="${labelY}" font-family="system-ui" font-size="15" fill="#00AA00" text-anchor="middle">${paceMiles}</text>`;

      // 250 and 500 mile markers
      [250, 500, 750].forEach(milestone => {
        const x = milesToX(milestone);
        svg += `
  
  <!-- ${milestone} mile marker -->
  <line x1="${x}" y1="${milestoneY1}" x2="${x}" y2="${milestoneY2}" stroke="#FF0000" stroke-width="3" stroke-dasharray="8,8"/>
  <text x="${x}" y="${milestoneY1 - 10}" font-family="system-ui" font-size="16" font-weight="600" fill="#FF0000" text-anchor="middle">Milestone</text>
  <text x="${x}" y="${labelY}" font-family="system-ui" font-size="15" fill="#FF0000" text-anchor="middle">${milestone}</text>`;
      });

      // Animated position markers
      runners.forEach((runner, index) => {
        const y = startY + (index * rowHeight);
        const x = milesToX(runner.miles);
        
        svg += `
  
  <!-- ${runner.name} marker -->
  <circle cx="${x}" cy="${y}" r="12" fill="${runner.color}" opacity="0.8">
    <animate attributeName="r" from="12" to="24" dur="1s" repeatCount="indefinite"/>
    <animate attributeName="opacity" from="0.8" to="0" dur="1s" repeatCount="indefinite"/>
  </circle>
  <circle cx="${x}" cy="${y}" r="10" fill="${runner.color}" filter="url(#shadow)"/>
  <circle cx="${x}" cy="${y}" r="6" fill="#FFFFFF"/>
  <text x="${x}" y="${y - 15}" font-family="system-ui" font-size="13" font-weight="600" fill="#1A1A1A" text-anchor="middle">${runner.miles}</text>`;
      });

      // Group total
      svg += `
  
  <!-- Group Total -->
  <text x="${width/2}" y="${height - 20}" font-family="system-ui" font-size="18" fill="#666" text-anchor="middle">Group Total: ${totalMiles.toLocaleString()} miles (${(totalMiles / (runners.length * 1000) * 100).toFixed(1)}% of combined goal)</text>`;

      svg += `
</svg>`;

      return svg;
    }

    // Main initialization
    async function init() {
      const container = document.getElementById('visualization');
      
      try {
        const runners = await fetchSheetData();
        
        if (runners.length === 0) {
          container.innerHTML = '<div id="error">No runner data found. Please check the Google Sheet format.</div>';
          return;
        }
        
        container.innerHTML = generateSVG(runners);
      } catch (error) {
        container.innerHTML = `<div id="error">Error loading data: ${error.message}<br><br>Please check that the Google Sheet is published and accessible.</div>`;
      }
    }

    // Run on page load
    init();
    
    // Refresh every 5 minutes
    setInterval(init, 5 * 60 * 1000);
  </script>
</body>
</html>
